name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run tests
        run: npm test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository with LFS
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Pull LFS files
        run: git lfs pull

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Verify clean git state
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "ERROR: Unexpected changes in working directory"
            git status --porcelain
            exit 1
          fi
          echo "Git state is clean"

      - name: Verify LFS files are real binaries (not pointers)
        run: |
          echo "Checking .deb files..."
          for file in public/*.deb; do
            if [ -f "$file" ]; then
              # Check if file starts with LFS pointer signature
              if head -c 50 "$file" | grep -q "version https://git-lfs"; then
                echo "ERROR: $file is an LFS pointer, not the actual binary!"
                exit 1
              fi
              # Verify it's a real Debian package
              if head -c 10 "$file" | grep -q "!<arch>"; then
                SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
                echo "âœ“ $file is a valid Debian package (${SIZE} bytes)"
              else
                echo "WARNING: $file may not be a valid Debian package"
              fi
            fi
          done
          echo "All LFS files verified!"

      - name: Inject build metadata
        run: node scripts/inject-build-info.js
        env:
          VERSION: ${{ github.event.repository.default_branch }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_FUTUREATOMS_WEBSITE }}
          channelId: live
          projectId: futureatoms-website

      - name: Create deployment tag
        run: |
          VERSION=$(node -p "require('./package.json').version")
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          TAG="deploy-v${VERSION}-${COMMIT_SHORT}-${TIMESTAMP}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Deployed to Firebase Hosting

          Version: ${VERSION}
          Commit: ${COMMIT_SHORT}
          Build: ${{ github.run_number }}
          Deployed: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

          git push origin "$TAG"
          echo "Created deployment tag: $TAG"
